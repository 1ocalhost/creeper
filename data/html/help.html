<!DOCTYPE html>
<html>
  <head>
    <link rel="icon" href="/img/creeper.png"/>
    <title>Help - Creeper</title>
    <style>
      body {
        background: #c8d5ef;
        font-family: monospace;
      }

      .dialog-bg {
        margin-left: auto;
        margin-right: auto;
        margin-top: 100px;
        overflow: hidden;
        width: 768px;
        height: 448px;
        background-image: url("/img/dialog_bg.png");
        box-shadow: 0px 0px 10px 0px #00000061;
      }

      #text {
        margin-top: 309px;
        padding: 0 25px;
        height: 122px;
        color: #81f517;
        font-size: 16px;
        overflow: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      #text::-webkit-scrollbar {
        display: none;
      }

      a[href] {
        -webkit-transition: color 0.5s ease-out; /* For Safari 3.0 to 6.0 */
        transition: color 0.5s ease-out; /* For modern browsers */
      }

      a:link, a:visited {
        color: #09c8e6;
      }

      a[href]:hover, a[href]:active {
        color: #b6f5ff;
      }
    </style>
  </head>
  <body>

  <div class="dialog-bg">
    <div id="text">
    </div>
  </div>

  <script>
    // global
    var funcSet = [];

    if (typeof String.prototype.trim !== 'function') {
      String.prototype.trim = function() {
        return this.replace(/^\s+|\s+$/g, ''); 
      };
    }

    function replaceAll(str, find, replace) {
      return str.replace(new RegExp(find, 'g'), replace);
    }

    function callFuncById(funcId) {
      funcSet[funcId](funcId);
    }

    // local
    (function () {
      var textEl = document.getElementById('text');
      var bindedScreen = {};
      var apiToken = '';

      function isFunction(val) {
        return val && {}.toString.call(val) === '[object Function]';
      }

      function write(text, links) {
        var html = '<a>' + text + '</a>';
        for (var key in links) {
          if (links.hasOwnProperty(key)) {
            var linkText = key;
            var func = links[key];
            if (linkText[0] === '\n') {
              html += '<br />';
            } else {
              html += ' ';
            }

            var funcId = func;
            if (isFunction(func)) {
              funcId = funcSet.length;
              funcSet[funcId] = func;
            }
            html += ('<a href="#" onclick="callFuncById(' + funcId + ')">'
              + linkText + '</a>');
          }
        }
        textEl.innerHTML = html;
      }

      function bindScreen(funcId) {
        if (bindedScreen.hasOwnProperty(funcId)) {
          return;
        }
        bindedScreen[funcId] = textEl.innerHTML;
      }

      function resetScreen(funcId) {
        if (bindedScreen.hasOwnProperty(funcId)) {
          textEl.innerHTML = bindedScreen[funcId];
        }
      }

      function httpGet(url) {
        var r = new XMLHttpRequest();
        r.open('GET', url, false);
        r.send(null);
        return r;
      }

      function httpPostApi(url, obj) {
        var r = new XMLHttpRequest();
        var fullUrl = (url + '?token=' + apiToken);
        r.open('POST', fullUrl, false);
        r.setRequestHeader('Content-Type', 'application/json');
        r.send(JSON.stringify(obj));
        return r;
      }

      function askSubscription(funcId) {
        var link = prompt('Subscription Link', '');
        if (link === null) {
          return;
        }

        link = link.trim();
        if (!link) {
          return;
        }

        bindScreen(funcId);
        write('Waiting...');

        var r = httpPostApi('/api/set_value', {
          key: 'feed_url',
          value: link
        });

        if (r.status === 200) {
          return true;
        } else {
          write('Sorry, something went wrong.', {
            'Retry': funcId
          });
          return false;
        }
      }

      function diagnosis() {
        textEl.innerHTML = '';
        appendLog('Waiting...\n');

        var iframe = document.createElement('iframe');
        iframe.src = ('/api/diagnosis' + '?token=' + apiToken);
        iframe.style.cssText = 'width:0; height:0; border:0; border:none';
        document.body.appendChild(iframe);
      }

      function startDialog(didLinkSet) {
        if (didLinkSet) {
          write('May i help you?', {
            '\n1. Cannot open international websites.': function() {
              diagnosis();
            },
            '\n2. Update my subscription link.': function(funcId) {
              if (askSubscription(funcId)) {
                resetScreen(funcId);
              }
            },
            '\n3. About this software.': function(funcId) {
              var blabla = 'Acknowledgments: ' +
                'I would like to thank the Python project which this program mostly based on. ' +
                'Likewise, I would not have been able to write this program without the motivation from Sherry.';
              bindScreen(funcId);
              write(blabla, {
                'Okay': function() {
                  resetScreen(funcId);
                }
              });
            },
          });
        } else {
          write('Please set your subscription link first.', {
            'Okay': function(funcId) {
              if (askSubscription(funcId)) {
                write('Would you like to try to connect now?', {
                  'Yep': function() {
                    diagnosis();
                  }
                });
              }
            }
          });
        }
      }

      function main() {
        var r = httpGet('/api/token');
        if (r.status === 200) {
          apiToken = JSON.parse(r.responseText).token;
          var r = httpGet('/api/user_conf');
          if (r.status === 200) {
            var user_conf = JSON.parse(r.responseText);
            startDialog(!!user_conf['feed_url']);
          }
        }
      }

      window.appendLog = function(text) {
        var html = replaceAll('<a>' + text + '</a>', '\n', '</a><br /><a>');
        var html = replaceAll(html, '<a></a>', '');
        textEl.innerHTML += html;
        textEl.scrollTop = textEl.scrollHeight;
      }

      window.updateState = function(state) {
        if (state === 'ok') {
          write('Aha! You can now enjoy the freedom.');
        } else {
          write('Bad state: ' + state);
        }
      }

      window.onload = main;
    })();
  </script>

  </body>
</html>
